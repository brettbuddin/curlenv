#!/usr/bin/env bash
#
# Usage: curlenv-switch <environment>

set -euo pipefail

echo_err() { echo "curlenv-switch: $*" 1>&2; }

[[ -x "$(command -v direnv)" ]] || (echo_err "direnv not found" && exit 1)

readonly target_env="$1"

[[ -f env/$target_env.envrc ]] || (echo_err "unknown environment: $target_env" && exit 1)

self_path=$(cd "$(dirname "$0")" && pwd -P)
project_path=$(realpath "$self_path/..")
curlenv_envrc="$project_path/.envrc.curlenv"

cat > "$curlenv_envrc" <<EOF
# DO NOT EDIT! Generated by curlenv-switch.

export CURLENV_CURRENT="${target_env}"

source_env env/${target_env}.envrc
source_env_if_exists env/${target_env}.secret.envrc
EOF

if [[ -f "$project_path/required-variables.txt" ]]; then
    {
        echo
        echo "env_vars_required" "$(tr '\n' ' ' < "$project_path/required-variables.txt")"
    } >> "$curlenv_envrc"
fi
